{"version":3,"file":"interface.js","names":["HttpApiEvent"],"sources":["../../src/http-api/interface.ts"],"sourcesContent":["/*\nCopyright 2022 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { type MatrixError } from \"./errors.ts\";\nimport { type Logger } from \"../logger.ts\";\nimport { type QueryDict } from \"../utils.ts\";\n\nexport type Body = Record<string, any> | BodyInit;\n\n/**\n * @experimental\n * Unencrypted access and (optional) refresh token\n */\nexport type AccessTokens = {\n    /**\n     * The new access token to use for authenticated requests\n     */\n    accessToken: string;\n    /**\n     * The new refresh token to use for refreshing tokens, optional\n     */\n    refreshToken?: string;\n    /**\n     * Approximate date when the access token will expire, optional\n     */\n    expiry?: Date;\n};\n\n/**\n * @experimental\n * Function that performs token refresh using the given refreshToken.\n * Returns a promise that resolves to the refreshed access and (optional) refresh tokens.\n *\n * Can be passed to HttpApi instance as {@link IHttpOpts.tokenRefreshFunction} during client creation {@link ICreateClientOpts}\n */\nexport type TokenRefreshFunction = (refreshToken: string) => Promise<AccessTokens>;\n\n/** Options object for `FetchHttpApi` and {@link MatrixHttpApi}. */\nexport interface IHttpOpts {\n    fetchFn?: typeof globalThis.fetch;\n\n    baseUrl: string;\n    idBaseUrl?: string;\n    prefix: string;\n    extraParams?: QueryDict;\n\n    accessToken?: string;\n    /**\n     * Used in conjunction with tokenRefreshFunction to attempt token refresh\n     */\n    refreshToken?: string;\n    /**\n     * Function to attempt token refresh when a possibly expired token is encountered\n     * Optional, only called when a refreshToken is present\n     */\n    tokenRefreshFunction?: TokenRefreshFunction;\n    useAuthorizationHeader?: boolean; // defaults to true\n\n    /** For historical reasons, must be set to `true`. Will eventually be removed. */\n    onlyData?: boolean;\n\n    localTimeoutMs?: number;\n\n    /** Optional logger instance. If provided, requests and responses will be logged. */\n    logger?: Logger;\n}\n\n/** Options object for `FetchHttpApi.requestOtherUrl`. */\nexport interface BaseRequestOpts extends Pick<RequestInit, \"priority\"> {\n    /**\n     * map of additional request headers\n     */\n    headers?: Record<string, string>;\n    abortSignal?: AbortSignal;\n    /**\n     * The maximum amount of time to wait before\n     * timing out the request. If not specified, there is no timeout.\n     */\n    localTimeoutMs?: number;\n    keepAlive?: boolean; // defaults to false\n\n    /**\n     * By default, we will:\n     *\n     *  *  If the `body` is an object, JSON-encode it and set `Content-Type: application/json` in the\n     *     request headers (unless overridden by {@link headers}).\n     *\n     *  * Set `Accept: application/json` in the request headers (again, unless overridden by {@link headers}).\n     *\n     *  * Parse the response as JSON and return the parsed response.\n     *\n     * Setting this to `false` inhibits all three behaviors, and the response is instead parsed as a UTF-8 string. It\n     * defaults to `true`, unless {@link rawResponseBody} is set.\n     *\n     * @deprecated Instead of setting this to `false`, set {@link rawResponseBody} to `true`.\n     */\n    json?: boolean;\n\n    /**\n     * Setting this to `true` does two things:\n     *\n     *  * Inhibits the automatic addition of `Accept: application/json` in the request headers.\n     *\n     *  * Causes the raw response to be returned as a {@link https://developer.mozilla.org/en-US/docs/Web/API/Blob|Blob}\n     *    instead of parsing it as JSON.\n     */\n    rawResponseBody?: boolean;\n}\n\nexport interface IRequestOpts extends BaseRequestOpts {\n    /**\n     * The alternative base url to use.\n     * If not specified, uses this.opts.baseUrl\n     */\n    baseUrl?: string;\n    /**\n     * The full prefix to use e.g.\n     * \"/_matrix/client/v2_alpha\". If not specified, uses this.opts.prefix.\n     */\n    prefix?: string;\n\n    // Set to true to prevent the request function from emitting a Session.logged_out event.\n    // This is intended for use on endpoints where M_UNKNOWN_TOKEN is a valid/notable error response,\n    // such as with token refreshes.\n    inhibitLogoutEmit?: boolean;\n}\n\nexport interface IContentUri {\n    base: string;\n    path: string;\n    params: {\n        // eslint-disable-next-line camelcase\n        access_token: string;\n    };\n}\n\nexport enum HttpApiEvent {\n    SessionLoggedOut = \"Session.logged_out\",\n    NoConsent = \"no_consent\",\n}\n\nexport type HttpApiEventHandlerMap = {\n    /**\n     * Fires whenever the login session the JS SDK is using is no\n     * longer valid and the user must log in again.\n     * NB. This only fires when action is required from the user, not\n     * when then login session can be renewed by using a refresh token.\n     * @example\n     * ```\n     * matrixClient.on(\"Session.logged_out\", function(errorObj){\n     *   // show the login screen\n     * });\n     * ```\n     */\n    [HttpApiEvent.SessionLoggedOut]: (err: MatrixError) => void;\n    /**\n     * Fires when the JS SDK receives a M_CONSENT_NOT_GIVEN error in response\n     * to a HTTP request.\n     * @example\n     * ```\n     * matrixClient.on(\"no_consent\", function(message, contentUri) {\n     *     console.info(message + ' Go to ' + contentUri);\n     * });\n     * ```\n     */\n    [HttpApiEvent.NoConsent]: (message: string, consentUri: string) => void;\n};\n\nexport interface UploadProgress {\n    loaded: number;\n    total: number;\n}\n\nexport interface UploadOpts {\n    /**\n     * Name to give the file on the server. Defaults to <tt>file.name</tt>.\n     */\n    name?: string;\n    /**\n     * Content-type for the upload. Defaults to\n     *   <tt>file.type</tt>, or <tt>applicaton/octet-stream</tt>.\n     */\n    type?: string;\n    /**\n     * if false will not send the filename,\n     *   e.g for encrypted file uploads where filename leaks are undesirable.\n     *   Defaults to true.\n     */\n    includeFilename?: boolean;\n    /**\n     * Optional. Called when a chunk of\n     *    data has been uploaded, with an object containing the fields `loaded`\n     *    (number of bytes transferred) and `total` (total size, if known).\n     */\n    progressHandler?(progress: UploadProgress): void;\n    abortController?: AbortController;\n}\n\nexport interface Upload {\n    loaded: number;\n    total: number;\n    promise: Promise<UploadResponse>;\n    abortController: AbortController;\n}\n\nexport interface UploadResponse {\n    // eslint-disable-next-line camelcase\n    content_uri: string;\n}\n\nexport type FileType = XMLHttpRequestBodyInit;\n"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAQA;AACA;AACA;AACA;;AAgBA;AACA;AACA;AACA;AACA;AACA;AACA;;AAGA;;AA8BA;;AAqEA,WAAYA,YAAY,0BAAZA,YAAY;EAAZA,YAAY;EAAZA,YAAY;EAAA,OAAZA,YAAY;AAAA","ignoreList":[]}