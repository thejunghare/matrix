{"version":3,"file":"RoomKeyTransport.js","names":["EventType","logger","rootLogger","KeyTransportEvents","TypedEventEmitter","RoomEvent","RoomKeyTransport","setParentLogger","parentLogger","getChild","constructor","room","client","statistics","_defineProperty","start","on","Timeline","ev","consumeCallEncryptionEvent","stop","off","event","_arguments","arguments","_this","_asyncToGenerator","isRetry","length","undefined","decryptEventIfNeeded","isDecryptionFailure","warn","concat","getId","decryptionFailureReason","setTimeout","info","getType","CallEncryptionKeysPrefix","Promise","resolve","error","getRoomId","onEncryptionEvent","sendKey","keyBase64Encoded","index","members","_this2","content","keys","key","device_id","getDeviceId","call_id","sent_ts","Date","now","sendEvent","roomId","matrixError","cancelPendingEvent","userId","getSender","getContent","deviceId","callId","Array","isArray","getUserId","counters","roomEventEncryptionKeysReceived","age","getTs","totals","roomEventEncryptionKeysReceivedTotalAge","encryptionKey","encryptionKeyIndex","debug","emit","ReceivedKeys"],"sources":["../../src/matrixrtc/RoomKeyTransport.ts"],"sourcesContent":["/*\nCopyright 2025 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport type { MatrixClient } from \"../client.ts\";\nimport { type EncryptionKeysEventContent, type ParticipantDeviceInfo, type Statistics } from \"./types.ts\";\nimport { EventType } from \"../@types/event.ts\";\nimport { type MatrixError } from \"../http-api/errors.ts\";\nimport { logger as rootLogger, type Logger } from \"../logger.ts\";\nimport { KeyTransportEvents, type KeyTransportEventsHandlerMap, type IKeyTransport } from \"./IKeyTransport.ts\";\nimport { type MatrixEvent } from \"../models/event.ts\";\nimport { TypedEventEmitter } from \"../models/typed-event-emitter.ts\";\nimport { type Room, RoomEvent } from \"../models/room.ts\";\n\nexport class RoomKeyTransport\n    extends TypedEventEmitter<KeyTransportEvents, KeyTransportEventsHandlerMap>\n    implements IKeyTransport\n{\n    private logger: Logger = rootLogger;\n    public setParentLogger(parentLogger: Logger): void {\n        this.logger = parentLogger.getChild(`[RoomKeyTransport]`);\n    }\n    public constructor(\n        private room: Pick<Room, \"on\" | \"off\" | \"roomId\">,\n        private client: Pick<\n            MatrixClient,\n            \"sendEvent\" | \"getDeviceId\" | \"getUserId\" | \"cancelPendingEvent\" | \"decryptEventIfNeeded\"\n        >,\n        private statistics: Statistics,\n        parentLogger?: Logger,\n    ) {\n        super();\n        this.setParentLogger(parentLogger ?? rootLogger);\n    }\n    public start(): void {\n        this.room.on(RoomEvent.Timeline, (ev) => void this.consumeCallEncryptionEvent(ev));\n    }\n    public stop(): void {\n        this.room.off(RoomEvent.Timeline, (ev) => void this.consumeCallEncryptionEvent(ev));\n    }\n\n    private async consumeCallEncryptionEvent(event: MatrixEvent, isRetry = false): Promise<void> {\n        await this.client.decryptEventIfNeeded(event);\n\n        if (event.isDecryptionFailure()) {\n            if (!isRetry) {\n                this.logger.warn(\n                    `Decryption failed for event ${event.getId()}: ${event.decryptionFailureReason} will retry once only`,\n                );\n                // retry after 1 second. After this we give up.\n                setTimeout(() => void this.consumeCallEncryptionEvent(event, true), 1000);\n            } else {\n                this.logger.warn(`Decryption failed for event ${event.getId()}: ${event.decryptionFailureReason}`);\n            }\n            return;\n        } else if (isRetry) {\n            this.logger.info(`Decryption succeeded for event ${event.getId()} after retry`);\n        }\n\n        if (event.getType() !== EventType.CallEncryptionKeysPrefix) return Promise.resolve();\n\n        if (!this.room) {\n            this.logger.error(`Got room state event for unknown room ${event.getRoomId()}!`);\n            return Promise.resolve();\n        }\n\n        this.onEncryptionEvent(event);\n    }\n\n    /** implements {@link IKeyTransport#sendKey} */\n    public async sendKey(keyBase64Encoded: string, index: number, members: ParticipantDeviceInfo[]): Promise<void> {\n        // members not used in room transports as the keys are sent to all room members\n        const content: EncryptionKeysEventContent = {\n            keys: [\n                {\n                    index: index,\n                    key: keyBase64Encoded,\n                },\n            ],\n            device_id: this.client.getDeviceId()!,\n            call_id: \"\",\n            sent_ts: Date.now(),\n        };\n\n        try {\n            await this.client.sendEvent(this.room.roomId, EventType.CallEncryptionKeysPrefix, content);\n        } catch (error) {\n            this.logger.error(\"Failed to send call encryption keys\", error);\n            const matrixError = error as MatrixError;\n            if (matrixError.event) {\n                // cancel the pending event: we'll just generate a new one with our latest\n                // keys when we resend\n                this.client.cancelPendingEvent(matrixError.event);\n            }\n            throw error;\n        }\n    }\n\n    public onEncryptionEvent(event: MatrixEvent): void {\n        const userId = event.getSender();\n        const content = event.getContent<EncryptionKeysEventContent>();\n\n        const deviceId = content[\"device_id\"];\n        const callId = content[\"call_id\"];\n\n        if (!userId) {\n            this.logger.warn(`Received m.call.encryption_keys with no userId: callId=${callId}`);\n            return;\n        }\n\n        // We currently only handle callId = \"\" (which is the default for room scoped calls)\n        if (callId !== \"\") {\n            this.logger.warn(\n                `Received m.call.encryption_keys with unsupported callId: userId=${userId}, deviceId=${deviceId}, callId=${callId}`,\n            );\n            return;\n        }\n\n        if (!Array.isArray(content.keys)) {\n            this.logger.warn(`Received m.call.encryption_keys where keys wasn't an array: callId=${callId}`);\n            return;\n        }\n\n        if (userId === this.client.getUserId() && deviceId === this.client.getDeviceId()) {\n            // We store our own sender key in the same set along with keys from others, so it's\n            // important we don't allow our own keys to be set by one of these events (apart from\n            // the fact that we don't need it anyway because we already know our own keys).\n            this.logger.info(\"Ignoring our own keys event\");\n            return;\n        }\n\n        this.statistics.counters.roomEventEncryptionKeysReceived += 1;\n        const age = Date.now() - (typeof content.sent_ts === \"number\" ? content.sent_ts : event.getTs());\n        this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge += age;\n\n        for (const key of content.keys) {\n            if (!key) {\n                this.logger.info(\"Ignoring false-y key in keys event\");\n                continue;\n            }\n\n            const encryptionKey = key.key;\n            const encryptionKeyIndex = key.index;\n\n            if (\n                !encryptionKey ||\n                encryptionKeyIndex === undefined ||\n                encryptionKeyIndex === null ||\n                callId === undefined ||\n                callId === null ||\n                typeof deviceId !== \"string\" ||\n                typeof callId !== \"string\" ||\n                typeof encryptionKey !== \"string\" ||\n                typeof encryptionKeyIndex !== \"number\"\n            ) {\n                this.logger.warn(\n                    `Malformed call encryption_key: userId=${userId}, deviceId=${deviceId}, encryptionKeyIndex=${encryptionKeyIndex} callId=${callId}`,\n                );\n            } else {\n                this.logger.debug(\n                    `onCallEncryption userId=${userId}:${deviceId} encryptionKeyIndex=${encryptionKeyIndex} age=${age}ms`,\n                );\n                this.emit(\n                    KeyTransportEvents.ReceivedKeys,\n                    userId,\n                    deviceId,\n                    encryptionKey,\n                    encryptionKeyIndex,\n                    event.getTs(),\n                );\n            }\n        }\n    }\n}\n"],"mappings":"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","ignoreList":[]}